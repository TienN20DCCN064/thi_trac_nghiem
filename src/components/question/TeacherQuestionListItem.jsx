import React, { useState, useEffect } from "react";
import { Table, Button, Modal, message } from "antd";
import {
  EyeOutlined,
  EditOutlined,
  DeleteOutlined,
  PlusOutlined,
} from "@ant-design/icons";
import CellDisplay from "../common/CellDisplay.jsx";
import TeacherQuestionDetailModal from "./TeacherQuestionDetailModal.jsx";
import ImportExportExcel from "./import_export_excel/ImportExportExcel.jsx";
import hamChiTiet from "../../services/service.hamChiTiet.js";
import { getUserInfo } from "../../globals/globals.js";
import { useDispatch } from "react-redux";
import { createActions } from "../../redux/actions/factoryActions.js";
import hamChung from "../../services/service.hamChung.js";

const teacherSubjectActions = createActions("cau_hoi");

function handleCheckPageParam() {
  const query = new URLSearchParams(window.location.search);
  let page = Number(query.get("page")) || 1;
  let pageSize = Number(query.get("pageSize")) || 10;
  return { page, pageSize };
}

const TeacherQuestionListItem = ({ data = [], status_question }) => {
  const dispatch = useDispatch();
  const [currentPage, setCurrentPage] = useState(handleCheckPageParam().page);
  const [pageSize, setPageSize] = useState(handleCheckPageParam().pageSize);

  const [modalVisible, setModalVisible] = useState(false);
  const [selectedId, setSelectedId] = useState(null);
  const [modalMode, setModalMode] = useState("view");

  const [infoTeacher, setInfoTeacher] = useState(null);
  const [showImportExport, setShowImportExport] = useState(false);

  const total = Array.isArray(data) ? data.length : 0;
  const maxPage = Math.ceil(total / pageSize) || 1;
  const validCurrentPage = Math.min(Math.max(1, currentPage), maxPage);

  useEffect(() => {
    if (validCurrentPage !== currentPage) {
      setCurrentPage(validCurrentPage);
    }
  }, [validCurrentPage, currentPage]);

  useEffect(() => {
    const fetchData = async () => {
      const info = await hamChiTiet.getUserInfoByAccountId(
        getUserInfo().id_tai_khoan
      );
      setInfoTeacher(info);
    };
    fetchData();
  }, []);

  const paginatedData = Array.isArray(data)
    ? data.slice((validCurrentPage - 1) * pageSize, validCurrentPage * pageSize)
    : [];

  // X·ª≠ l√Ω x√≥a
  const handleDelete = async (record) => {
    try {
      const timeout = new Promise((_, reject) =>
        setTimeout(
          () => reject(new Error("K·∫øt n·ªëi m√°y ch·ªß th·∫•t b·∫°i sau 10 gi√¢y!")),
          10000
        )
      );
      const res = await Promise.race([
        hamChung.deleteListQuestions(record),
        timeout,
      ]);

      if (res.success) {
        message.success(res.message || "X√≥a c√¢u h·ªèi th√†nh c√¥ng!");
        dispatch(teacherSubjectActions.creators.fetchAllRequest());
      } else {
        message.error(res.message || "X√≥a c√¢u h·ªèi th·∫•t b·∫°i!");
      }
    } catch (error) {
      message.error(error.message || "Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß!");
    }
  };

  const columns = [
    {
      title: "#",
      key: "index",
      width: 40,
      align: "center",
      render: (_, __, index) => index + 1 + (validCurrentPage - 1) * pageSize,
    },
    {
      title: "Gi·∫£ng Vi√™n",
      dataIndex: "ma_gv",
      key: "ma_gv",
      render: (value) => <CellDisplay table="giao_vien" id={value} />,
    },
    {
      title: "M√¥n H·ªçc",
      dataIndex: "ma_mh",
      key: "ma_mh",
      render: (value) => (
        <CellDisplay table="mon_hoc" id={value} fieldName="ten_mh" />
      ),
    },
    {
      title: "Tr√¨nh ƒë·ªô",
      dataIndex: "trinh_do",
      key: "trinh_do",
      align: "center",
      render: (value) =>
        value === "ƒêH"
          ? "ƒê·∫°i H·ªçc"
          : value === "Cƒê"
          ? "Cao ƒê·∫≥ng"
          : value === "VB2"
          ? "VƒÉn B·∫±ng 2"
          : "Kh√°c",
    },
    {
      title: "S·ªë c√¢u h·ªèi ƒë√£ so·∫°n",
      dataIndex: "so_cau_hoi",
      key: "so_cau_hoi",
      align: "center",
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      align: "right",
      width: 150,
      render: (_, record) => {
        const user = getUserInfo();
        return (
          <div>
            <Button
              size="small"
              type="primary"
              icon={<EyeOutlined />}
              onClick={() => {
                setSelectedId({
                  ma_gv: record.ma_gv,
                  ma_mh: record.ma_mh,
                  trinh_do: record.trinh_do,
                });
                setModalMode("view");
                setModalVisible(true);
              }}
              style={{ marginLeft: 8 }}
            />
            <Button
              size="small"
              type="dashed"
              icon={<EditOutlined />}
              disabled={user?.vai_tro !== "GiaoVien"}
              onClick={() => {
                if (user?.vai_tro !== "GiaoVien") return;
                setSelectedId({
                  ma_gv: record.ma_gv,
                  ma_mh: record.ma_mh,
                  trinh_do: record.trinh_do,
                });
                setModalMode("edit");
                setModalVisible(true);
              }}
              style={{ marginLeft: 8 }}
            />
            <Button
              size="small"
              danger
              type="primary"
              icon={<DeleteOutlined />}
              disabled={user?.vai_tro !== "GiaoVien"}
              onClick={() => {
                if (user?.vai_tro !== "GiaoVien") return;
                Modal.confirm({
                  title: "B·∫°n c√≥ mu·ªën x√≥a c√¢u h·ªèi n√†y kh√¥ng?",
                  okText: "C√≥",
                  okType: "danger",
                  cancelText: "Kh√¥ng",
                  onOk() {
                    handleDelete(record);
                  },
                });
              }}
              style={{ marginLeft: 8 }}
            />
          </div>
        );
      },
    },
  ];

  return (
    <>
      {status_question === "chua_xoa" &&
      getUserInfo().vai_tro === "GiaoVien" ? (
        <div style={{ marginBottom: 10, textAlign: "right" }}>
          {/* ‚úÖ N√∫t m·ªü modal Import/Export */}
          <Button
            type="default"
            onClick={() => setShowImportExport(true)}
            style={{ marginRight: 8 }}
          >
            Import/Export
          </Button>

          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setSelectedId(null);
              setModalMode("create");
              setModalVisible(true);
            }}
          >
            Th√™m C√¢u H·ªèi
          </Button>
        </div>
      ) : (
        <div style={{ marginBottom: 10, textAlign: "right", marginTop: 60 }} />
      )}

      {/* ‚ùå X√≥a ƒëo·∫°n showImportExport c≈© */}
      {/* ‚úÖ Th√™m Modal hi·ªÉn th·ªã Import/Export */}
      <Modal
        open={showImportExport}
        title="üìÇ Import / Export Question"
        footer={null}
        centered
        destroyOnClose
        onCancel={() => setShowImportExport(false)}
      >
        <ImportExportExcel/>
      </Modal>

      <Table
        rowKey={(record) =>
          record.id_cau_hoi ||
          `${record.ma_gv}_${record.ma_mh}_${record.trinh_do}`
        }
        columns={columns}
        dataSource={paginatedData}
        locale={{ emptyText: "Kh√¥ng c√≥ d·ªØ li·ªáu" }}
        pagination={{
          current: validCurrentPage,
          pageSize,
          total,
          showSizeChanger: true,
          pageSizeOptions: ["10", "15", "20", "50"],
          onChange: (page, newPageSize) => {
            setCurrentPage(page);
            setPageSize(newPageSize);
            const query = new URLSearchParams(window.location.search);
            query.set("page", page);
            query.set("pageSize", newPageSize);
            window.history.pushState(
              null,
              "",
              `${window.location.pathname}?${query.toString()}`
            );
          },
        }}
        style={{ width: "100%" }}
        tableLayout="fixed"
      />

      <TeacherQuestionDetailModal
        visible={modalVisible}
        maGV={selectedId?.ma_gv || infoTeacher?.ma_gv}
        maMH={selectedId?.ma_mh}
        trinhDo={selectedId?.trinh_do || "ƒêH"}
        mode={modalMode}
        onCancel={() => setModalVisible(false)}
        status_question={status_question}
      />
    </>
  );
};

export default TeacherQuestionListItem;
